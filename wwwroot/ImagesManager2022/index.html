<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="icon" href="favicon.ico">
</head>

<body>

    <div class="mainContainer">
        <div class="headerPanel">
            <div class="headerLayout">
                <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon" title="Gestionnaire d'images">
                <div style="display:flex">
                    <span class="header outLinedText tbg-yellow">
                        P
                    </span>
                    <span class="header outLinedText tbg-orange">
                        I
                    </span>
                    <span class="header outLinedText tbg-red">
                        C
                    </span>
                    <span class="header outLinedText tbg-pink ">
                        T
                    </span>
                    <span class="header outLinedText tbg-black">
                        -
                    </span>
                    <span class="header outLinedText tbg-purple">
                        C
                    </span>
                    <span class="header outLinedText tbg-blue">
                        L
                    </span>
                    <span class="header outLinedText tbg-green">
                        O
                    </span>
                    <span class="header outLinedText tbg-grass">
                        U
                    </span>
                    <span class="header outLinedText tbg-yellow">
                        D
                    </span>
                </div>
                <span class="cmd fa fa-plus-square" id="newImageCmd" title="Ajouter un image"
                    data-toggle="tooltip"></span>
            </div>


            <div class="connectionPanel">
                <div class="loggedUserAvatarContainer" id="loggedUserAvatarContainer"></div>
                <div id="loggedUserName"></div>
                <span class="cmd fa-sharp fa-solid fa-address-book" id="editAccountCmd" title="Mon Profil"
                    data-toggle="tooltip"></span>
                <span class="cmd fa fa-minus-square" id="newLogoutCmd" title="Se déconnecter"
                    data-toggle="tooltip"></span>
                <div>
                    <span class="cmd fa-sharp fa-solid fa-arrow-up-from-bracket" id="newloginCmd" title="Se connecter"
                        data-toggle="tooltip"></span>
                    <span class="cmd fa fa-registered" id="newRegisterCmd" title="S'enregister"
                        data-toggle="tooltip"></span>
                </div>


            </div>
        </div>


        <div id="searchImages">
            <div>
                <label for="users">Search by users</label>
                <select name="users" id="searchByUser">
                    <!-- create the options via code-->
                </select>

            </div>
        </div>



        <div class="scrollContainer">
            <div id="imagesList">
                <!-- filled programmatically-->
            </div>
        </div>
        <div>
            <div id="imageDlg">
                <form id="imageForm">
                    <input type="hidden" id="Id_input" value="0">
                    <input type="hidden" id="date_input" value="0">
                    <input type="hidden" id="GUID_input" value="">

                    <label for="title_input">Titre</label>
                    <input type="text" id="title_input" class="form-control" required>

                    <label for="decription_input">Description</label>
                    <textarea id="description_input" class="form-control" required></textarea>

                    <label for="image">Image</label>
                    <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                        waitingImage='images/writing.gif'>
                    </div>
                    <div class="note">Cliquez-Déposez une image</div>

                    <input type="hidden" id="UserId_input" value="0">
                    <label for="isShared_input">Shared</label>
                    <input type="checkbox" id="isShared_input" name="Shared" value="true">


                </form>
            </div>
            <div id="confirmDeleteImageDlg">
                <span id="deleteImageConfirmationMessage"></span>
            </div>
            <div id="errorDlg">
                <span id="errorMessage"></span>
            </div>
        </div>
    </div>




    <div>
        <div id="loginDlg">
            <form id="loginForm">
                <label for="loginEmail_input" class="form-control" required>Email</label>
                <input type="text" id="loginEmail_input" class="form-control" required>

                <label for="password_input">Password</label>
                <input type="password" id="password_input" class="form-control" required>
                <!--POUR LE MOMENT LE CHECKBOX NE FAIT RIEN-->
                <label for="isChecked_input">
                    <input type="checkbox" id="isChecked_input" name="Remember me" value="Remember me"> Remember me
                </label>
            </form>
        </div>
    </div>



    <div>
        <div id="verifyAccountDlg">
            <form id="verifyForm">

                <input type="hidden" id="Id_input" value="0">

                <label for="code_input">Veuillez entrer le code qui vous a été envoyé par email </label>
                <input type="password" id="code_input" class="form-control" required>
            </form>
        </div>
    </div>





    <div>
        <div id="accountDlg">
            <form id="accountForm">

                <input type="hidden" id="Id_input" value="0">
                <input type="hidden" id="GUID_input" value="">
                <input type="hidden" id="avatarUrl_input" value="">


                <label for="name_input">Nom d'usager</label>
                <input type="text" id="name_input" class="form-control" required>

                <label for="email_input">Courriel</label>
                <input type="email" id="email_input" class="form-control" required>

                <label for="mdp_input">Mot de passe</label>
                <input type="password" id="mdp_input" class="form-control" matchedPasswordId="mdpVerif_input">

                <label for="mdpVerif_input">Confirmer mot de passe</label>
                <input type="password" id="mdpVerif_input" class="form-control">

                <label for="avatar">avatar</label>
                <div id='avatar' class='ImageUploader' defaultImage='images/No_Image.png'
                    waitingImage='images/writing.gif'>
                </div>
                <div class="note">Cliquez-Déposez une image</div>
            </form>
        </div>

        <div id="confirmDeleteAccountDlg">
            <span id="deleteAccountConfirmationMessage"></span>
        </div>
        <div id="errorDlg">
            <span id="errorMessage"></span>
        </div>

    </div>

    <div id="logoutDlg">
        <form id="logoutForm">
            <div>Voulez-vous vous déconnectez?</div>
        </form>
    </div>


    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="js/customValidation.js"></script>
    <script src="js/imageUploader.js"></script>
    <script src="js/api.js"></script>
    <script src="js/date.js"></script>
    <script defer>
        const periodicRefreshPeriod = 15;
        let holdCheckETag = false;
        let currentETag = "";
        let createMode = true;
        let registerMode = false;
        let searchCategory = "";
        let searchTitle = "";
        let hideSearchBar = true;
        let imageIdToDelete = 0; // used by confirmDeleteDlg
        let accountIdToDelete = 0;
        let selectedCategory = "";
        let imagesCount = 50;
        let appendCount = 3;
        let previousScrollPosition = 0;
        let appendMode = false;
        let newAccountBool = false;

        $("#newImageCmd").hide();
        $("#editAccountCmd").hide();
        $("#newLogoutCmd").hide();

        init_UI();
        HEAD(checkETag, error);
        setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);

        function checkETag(ETag) {
            if (!holdCheckETag && ETag != currentETag) {
                currentETag = ETag;
                getImagesList();
            }
        }

        function getImagesList(refresh = true) {
            appendMode = !refresh;
            function prepareQueryString() {
                let queryString = "";
                if (appendMode) {
                    queryString = `?sort=Date,desc&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}`;
                    imagesCount += appendCount;
                } else {
                    queryString = `?sort=Date,desc&offset=${0}&limit=${imagesCount}`;
                }
                return queryString;
            }
            GET_ALL_IMAGES(refreshimagesList, error, prepareQueryString());
        }


        function refreshimagesList(images, ETag) {
            function insertIntoImageList(image) {

                $("#imagesList").append(
                    $(` 
                                <div class='imageLayout'>
                                    <div class='imageHeader'>
                                        <div class="imageTitle">${image.Title}</div>
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                    </div>
                                    <a href="${image.OriginalURL}" target="_blank">
                                        <div    class='image' 
                                                style="background-image:url('${image.ThumbnailURL}')">
                                                <div    class='avatar' 
                                                style="background-image:url('${image.AvatarGUID}')">
                                                
                                        </div>
                                        </div>
                                    </a>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                );
            }
            currentETag = ETag;
            previousScrollPosition = $(".scrollContainer").scrollTop();
            if (!appendMode) $("#imagesList").empty();

            if (appendMode && images.length == 0)
                imagesCount -= appendCount;

            for (let image of images) {
                insertIntoImageList(image);
            }

            $(".scrollContainer").scrollTop(previousScrollPosition);
            $(".editCmd").off();
            $(".deleteCmd").off();
            $(".showMore").off();
            $(".editCmd").click(e => { editimage(e) });
            $(".deleteCmd").click(e => { deleteimage(e) });

            $('[data-toggle="tooltip"]').tooltip();
        }


        function getUsersList(refresh = true) {
            appendMode = !refresh;
            function prepareQueryString() {
                let queryString = "";
                if (appendMode) {
                    queryString = `?sort=Created,desc`;
                } else {
                    queryString = `?sort=Created,desc`;
                }
                return queryString;
            }
            GET_ALL_USERS(refreshUserOptionList, error, prepareQueryString());
        }


        function refreshUserOptionList(users, ETag) {
            function insertIntoUsersList(users) {

                $("#searchByUser").append(
                    $(` 

                                <option value="${users.id}">${users.Name}</option>
                        `)
                );
            }
            currentETag = ETag;

            for (let user of users) {
                insertIntoUsersList(user);
            }
        }



        function error(status) {
            let errorMessage = "";
            switch (status) {
                case 0:
                    errorMessage = "Le service ne répond pas";
                    break;
                case 401:
                    errorMessage = "Requête non autorisée";
                    break;
                case 400:
                case 422:
                    errorMessage = "Requête invalide";
                    break;
                case 404:
                    errorMessage = "Service ou données introuvables";
                    break;
                case 409:
                    errorMessage = "Conflits de données: Hyperlien existe déjà";
                    break;
                case 500:
                    errorMessage = "Erreur interne du service";
                    break;
                default:
                    errorMessage = "Une erreur est survenue";
                    break;
            }
            $("#errorMessage").text(errorMessage);
            $("#errorDlg").dialog('open');
        }

        function newImage() {
            holdCheckETag = true;
            createMode = true;
            resetimageForm();
            ImageUploader.imageRequired('image', true);
            $("#imageDlg").dialog('option', 'title', "Ajout d'image");
            $("#imageDlgOkBtn").text("Ajouter");
            $("#imageDlg").dialog('open');
        }
        function editimage(e) {
            holdCheckETag = true;
            createMode = false;
            GET_ID_IMAGE(e.target.getAttribute("imageid"), imageToForm, error);
            holdCheckETag = true;
            ImageUploader.imageRequired('image', false);
            $("#imageDlg").dialog('option', 'title', "Modification d'image");
            $("#imageDlgOkBtn").text("Modifier");
            $("#imageDlg").dialog('open');
        }
        function deleteimage(e) {
            holdCheckETag = true;
            imageIdToDelete = e.target.getAttribute("imageid")
            GET_ID_IMAGE(
                imageIdToDelete,
                image => {
                    $("#deleteImageConfirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                },
                error
            );
            holdCheckETag = true;
            $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
            $("#confirmDeleteDlgOkBtn").text("Effacer");
            $("#confirmDeleteImageDlg").dialog('open');
        }
        function resetimageForm() {
            $("#Id_input").val("0");
            $("#GUID_input").val("");
            $("#date_input").val(Date.now());
            $("#title_input").val("");
            $("#description_input").val("");
            $("#UserId_input").val("0");
            $("#isShared_input").prop("unchecked");
            ImageUploader.resetImage('image');
        }
        function imageFromForm() {
            if ($("#imageForm")[0].checkValidity()) {
                let user = JSON.parse(sessionStorage.getItem("user"));

                let image = {
                    Id: parseInt($("#Id_input").val()),
                    GUID: $("#GUID_input").val(),
                    Title: $("#title_input").val(),
                    Description: $("#description_input").val(),
                    ImageData: ImageUploader.getImageData('image'),
                    Date: parseInt($("#date_input").val()),
                    UserId: user.Id,
                    Shared: $("#isShared_input").prop("checked")
                };
                return image;
            } else {
                $("#imageForm")[0].reportValidity()
            }
            return false;
        }
        function imageToForm(image) {
            $("#Id_input").val(image.Id);
            $("#GUID_input").val(image.GUID);
            $("#date_input").val(image.Date);
            //$("#date_input").val(Date.now());
            $("#title_input").val(image.Title);
            $("#description_input").val(image.Description);
            ImageUploader.setImage('image', image.OriginalURL);
        }



        function newAccount() {
            holdCheckETag = true;
            registerMode = true;
            resetAccountForm();
            ImageUploader.imageRequired('avatar', true);
            $("#accountDlg").dialog('option', 'title', "creer un compte");
            $("#accountDlgOkBtn").text("S'enregistrer");
            $("#accountDlg").dialog('open');
            $("#deleteAccountBtn").hide();
        }

        function editAccount() {
            holdCheckETag = true;
            registerMode = false;
            //GET_ID_USER(user /* getAttribute("imageid")*/, accountToForm(user), error);
            accountToForm(retrieveUserInfo());
            holdCheckETag = true;
            ImageUploader.imageRequired('avatar', false);
            $("#accountDlg").dialog('option', 'title', "Modification de compte");
            $("#accoutDlgOkBtn").text("Modifier");
            $("#accountDlg").dialog('open');
            $("#deleteAccountBtn").show();
        }

        function deleteAccount(e) {
            holdCheckETag = true;
            //accountIdToDelete = e.Id;
            //holdCheckETag = true;
            $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
            $("#confirmDeleteAccountDlgOkBtn").text("Effacer");
            $("#confirmDeleteAccountDlg").dialog('open');
        }
        function resetAccountForm() {
            $("#Id_input").val("0");
            $("#GUID_input").val("");
            $("#avatarUrl_input").val("");
            $("#name_input").val("");
            $("#email_input").val("");
            $("#mdp_input").val("");
            $("#mdpVerif_input").val(""),
                ImageUploader.resetImage('avatar');
        }
        function accountFromForm() {
            if ($("#accountForm")[0].checkValidity()) {
                let account = {
                    Id: parseInt($("#Id_input").val()),
                    Name: $("#name_input").val(),
                    Email: $("#email_input").val(),
                    Password: $("#mdp_input").val(),
                    AvatarGUID: $("#GUID_input").val(),
                    ImageData: ImageUploader.getImageData("avatar"),
                    AvatarURL: $("#avatarUrl_input").val()
                };
                return account;
            } else {
                $("#accountForm")[0].reportValidity()
            }
            return false;
        }
        function accountToForm(account) {
            $("#Id_input").val(account.Id);
            $("#name_input").val(account.Name);
            $("#email_input").val(account.Email);
            $("#GUID_input").val(account.AvatarGUID);
            ImageUploader.setImageData('avatar', account.AvatarURL);
            $("#avatarUrl_input").val(account.AvatarURL);

            /*
            $("")

            //$("#date_input").val(Date.now());
            $("#title_input").val(image.Title);
            $("#description_input").val(image.Description);
            ImageUploader.setImage('image', image.OriginalURL);
            */
        }


        //C'est l'ouverture du dlg pour se connecter
        function signIn() {
            holdCheckETag = true;
            $("#loginDlg").dialog('option', 'title', "Se connecter");
            $("#loginDlgOkBtn").text("Connexion");
            $("#loginDlg").dialog('open');
            if (localStorage.getItem("Email") != "" && localStorage.getItem("Password") != "") {
                $("#loginEmail_input").val(localStorage.getItem("mail"));
                $("#password_input").val(localStorage.getItem("Password"));
            }
        }

        //idem, mais pour se déconnecter
        function signOut() {
            holdCheckETag = true;
            //createMode = true;
            $("#logoutDlg").dialog('option', 'title', "Se connecter");
            $("#logoutDlgOkBtn").text("Se déconnecter");
            $("#logoutDlg").dialog('open');
        }
        //ça ouvre la page la dlg de confirmation
        function updateRegister() {
            holdCheckETag = true;
            registerMode = true;
            $("#verifyAccountDlg").dialog('open');
            //console.log("it works")
        }
        function setUserLocalstorage(user) {
            localStorage.setItem("user", JSON.stringify(user));
        }
        function setUserSessionStorage(user) {
            console.log(user);
            sessionStorage.setItem("user", JSON.stringify(user));
            //sessionStorage.setItem("userId", user.Id);
        }
        //ça permet à la connection automatique
        function updateConfirmation() {

        }
        //Ça vient changer le HTML pour faire comme si un compte est connecté
        function updateConnected() {
            if ($('#isChecked_input').is(':checked')) {
                let userLocal = retrieveCredentials();
                //console.log(userLocal);
                //setUserLocalstorage(userLocal);
                localStorage.setItem("mail", JSON.stringify(userLocal.Email));
                localStorage.setItem("Password", JSON.stringify(userLocal.Password));
            }
            //insertProfileInfomation();
            let userInfo = retrieveUserInfo();
            //let userInfo = retrieveCredentials();
            //setUserLocalstorage(userInfo);
            //setUserSessionStorage(userInfo);
            //console.log(userInfo)
            //console.log(userInfo.Name)
            //console.log(userInfo.Id)

            // afficher avatar et nom usager
            $('#loggedUserAvatarContainer').empty();
            $('#loggedUserAvatarContainer').append($("<img class='avatar' src='" + userInfo.AvatarURL + "' />"));
            $("#loggedUserName").text(userInfo.Name);

            $("#newloginCmd").hide();
            $("#newRegisterCmd").hide();
            $("#newImageCmd").show();
            $("#editAccountCmd").show();//modifier le compte , donc devoir changer le nom
            $("#newLogoutCmd").show();
            getImagesList();
        }
        //Ça vient rechanger le HTML pour faire en sorte que la page revienne comme avant(non connecté) (Le token va jouer un grand rôle la-dessus)
        function updateDisconnect() {
            //let profil = JSON.parse(localStorage.getItem('user'));
            let profil = JSON.parse(sessionStorage.getItem('user'));
            var userToRemove = profil.Id;

            $('#loggedUserAvatarContainer').empty();
            $("#loggedUserName").text('');

            //localStorage.removeItem("user");
            //localStorage.removeItem("token");
            sessionStorage.removeItem("user");
            sessionStorage.removeItem("token");
            //console.log(profil);

            $("#newloginCmd").show();
            $("#newRegisterCmd").show();

            $("#editAccountCmd").hide();//modifier le compte , donc devoir changer le nom
            $("#newLogoutCmd").hide();
            $("#newImageCmd").hide();
        }
        //On récupère les infos de l'utilisateur.
        function retrieveUserInfo() {
            //return JSON.parse(localStorage.getItem('user'));
            let user = JSON.parse(sessionStorage.getItem('user'));
            //console.log(user);
            return user;
        }
        //C'est relié au Login en retrivant l'email et le password
        function retrieveCredentials() {
            let user = {
                Email: $("#loginEmail_input").val(),
                Password: $("#password_input").val()
            };

            //let user = { "Email": $("#loginEmail_input").val(), "Password": $("#password_input").val() };
            return user;
        }
        //Ça correspond à la vérification du code fournis par le courriel automatisé
        function showEmailVerificationDlg(user) {

        }
        //Ça correspond à la vérification du code fournis par le courriel automatisé, ici on retourne le verifyUser
        // Si user dejà créer mais pas vérif
        function verifyCodeFromForm() {
            let user = JSON.parse(localStorage.getItem("user"));
            //let user = sessionStorage.getItem("user");
            let VerifyUser = {
                Id: user.Id,
                VerifyCode: $("#code_input").val()
            }
            return VerifyUser;
        }
        //c'est pour l'ouverture du dialogue pour l'enregistrement
        function registerIn() {

        }
        //Ici on rajoute les autres Dlg qu'on a créé dans cette fonction (Suivre les autres exemples dans la fonction)
        function init_UI() {
            $("#newImageCmd").click(newImage)
            $("#imageDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "imageDlgOkBtn",
                    text: "Title will be changed dynamically",
                    click: function () {
                        let image = imageFromForm();
                        if (image) {
                            if (createMode) {
                                PostImage(image, getImagesList, error);
                                $(".scrollContainer").scrollTop(0);
                            }
                            else
                                PutImage(image, getImagesList, error);
                            resetimageForm();
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });


            $("#editAccountCmd").click(editAccount);
            $("#newRegisterCmd").click(newAccount)
            $("#accountDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "accoutDlgOkBtn",
                    text: "S'enregistrer",
                    click: function () {
                        let user = accountFromForm();
                        if (user) {
                            if (registerMode) {
                                PostUser(user, setUserSessionStorage, error);
                                updateRegister();
                            }
                            else {
                                setUserSessionStorage(user);
                                editUser(user, updateConnected, error);
                            }

                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }
                    /*
                    text: "s'enregistrer",
                    click: function () {
                        if (newAccountBool) {
                            let user = accountFromForm();
                            //PostUser(user, setUserLocalstorage, updateRegister, error);
                            PostUser(user, setUserSessionStorage, error);
                            $(this).dialog("close");
                            updateRegister();
                            //alert("Vous vous avez bien enregister, allez voir votre boite mail pour confirmer votre inscription");
                        }

                    }
                    */
                },

                {
                    id: "deleteAccountBtn",
                    text: "Supprimer le compte",
                    click: function () {

                        DeleteUser(user, deleteAccount, error);
                    }
                },

                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            })




            /*
            $("#accountEditDlg").dialog({
                title: "Modifier profil",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "accoutDlgOkBtn",
                    text: "modifier",
                    click: function () {
                        //let user = retrieveUserInfo();
                        let user = accountFromForm();
                        if (user) {
                            setUserSessionStorage(user);
                            editUser(user, updateConnected, error);
    
                            //Modify(user, setUserLocalstorage, error);
    
                            $(this).dialog("close");
                            //updateRegister();
                            //alert("Vous vous avez bien enregister, allez voir votre boite mail pour confirmer votre inscription");
                        }
                    }
                },
                {
                    text: "Supprimer le compte",
                    click: function () {
                        let user = accountFromForm();
                        if (user) {
                            DeleteUser(user, deleteAccount, error);
                            $(this).dialogue("close");
                        }
                    }
                },
                {
    
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
    
                }]
            });
    
    */

            $("#newloginCmd").click(signIn)
            $("#loginDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 350,
                minHeight: 350,
                maxHeight: 350,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "loginDlgOkBtn",
                    text: "login",
                    click: function () {
                        let user = retrieveCredentials();
                        login(user, updateConnected, error);
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });



            $("#editAccountCmd").click(editAccount);
            /*
            $("#accountDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "editAccoutDlgOkBtn",
                    text: "modifier",
                    click: function () {
                        //let user = retrieveUserInfo();
                        let user = accountFromForm();
                        if (user) {
    
                            setUserSessionStorage(user);
                            editUser(user, updateConnected, error);
    
                            //Modify(user, setUserLocalstorage, error);
    
                            $(this).dialog("close");
                            //updateRegister();
                            //alert("Vous vous avez bien enregister, allez voir votre boite mail pour confirmer votre inscription");
    
    
                        }
                    }
                },
                {
                    id: "deleteAccountBtn",
                    text: "Supprimer le compte",
                    click: function () {
                        /*let user = accountFromForm();
                        if (user) {
                            DeleteUser(user, deleteAccount, error);
                            $(this).dialogue("close");
                        }*/
            /*
            deleteAccount();
            holdCheckETag = false;
            $(this).dialog("close");
        }
    
    },
    
    {
    
        text: "Annuler",
        click: function () {
            holdCheckETag = false;
            $(this).dialog("close");
        }
    
    }]
    });
    */

            //$("#VerifyAccountCmd").click(signIn)
            $("#verifyAccountDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 200,
                minHeight: 200,
                maxHeight: 200,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "verifyDlgOkBtn",
                    text: "verify",
                    click: function () {
                        let user = JSON.parse(sessionStorage.getItem("user"));
                        let code = $("#code_input").val();
                        if (registerMode) {
                            let data = { "Id": user, "VerifyCode": code };
                            verifyUser(data, setUserLocalstorage, updateRegister);
                            //verifyUser(data, setUserSessionStorage, updateRegister);
                            //verifyUser(data, signIn, updateRegister);
                        }
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });


            $("#newLogoutCmd").click(signOut)
            $("#logoutDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "logoutDlgOkBtn",
                    text: "se deconnecter",
                    click: function () {
                        //let user = retrieveCredentials();
                        let user = retrieveUserInfo();
                        logout(user, updateDisconnect, error);
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });


            $("#confirmDeleteImageDlg").dialog({
                title: "Attention!",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "confirmDeleteImageDlgOkBtn",
                    text: "Oui",
                    click: function () {
                        holdCheckETag = false;
                        if (imageIdToDelete)
                            DeleteImage(imageIdToDelete, getImagesList, error);
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });

            $("#confirmDeleteAccountDlg").dialog({
                title: "Attention!",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "confirmDeleteDlgOkBtn",
                    text: "Oui",
                    click: function () {
                        holdCheckETag = false;
                        if (accountIdToDelete)
                            deleteAccount(accountIdToDelete, updateDisconnect, error);
                        accountIdToDelete = 0;
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        accountIdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });



            $("#errorDlg").dialog({
                title: "Erreur...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    text: "Fermer",
                    click: function () {
                        holdCheckETag = false;
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });


            $(".scrollContainer").scroll(function () {
                if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                    getImagesList(false);
                }
            });
        }
    </script>

</body>

</html>